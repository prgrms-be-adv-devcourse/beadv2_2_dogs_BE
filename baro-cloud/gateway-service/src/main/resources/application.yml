server:
  port: 8080 # [1] README 기준 Gateway 포트(외부 진입점)
  netty:
    max-initial-line-length: 16384  #  추가 (기본값 4096 → 16384)
    h2c-max-content-length: 0       #  추가

spring:
  application:
    name: gateway-service # [2] Eureka 등록명 + Config Server 조회 키
  codec:
    max-in-memory-size: 10MB # 추가 (기본값은 256KB)
  config:
    import: optional:configserver:http://localhost:8888 # [3] 부트스트랩 시 Config Server(8888)에서 공통 설정 로드
  cloud:
    gateway:
      httpclient:
        max-header-size: 16KB #추가
        max-initial-line-length: 16384 #추가
      discovery:
        locator:
          enabled: true # [4] Eureka 서비스ID 기반 자동 라우팅 활성화
          lower-case-service-id: true # [5] 서비스ID를 소문자로 표준화해 경로 예측성 확보
      routes: # [6] README의 API 경로 표와 일치하도록 명시적 라우팅
#        - id: openapi
#          uri: http://localhost:8080
#          predicates:
#            - Path=/swagger-ui.html, /swagger-ui/**, /v3/api-docs/**, /webjars/**, /swagger-resources/**
#          filters:
#            - RemoveRequestHeader=Forwarded  #  Forwarded 헤더 제거
#            - RemoveRequestHeader=X-Forwarded-For
#            - RemoveRequestHeader=X-Forwarded-Proto
#            - RemoveRequestHeader=X-Forwarded-Port
#            - RemoveRequestHeader=X-Forwarded-Host

        # Auth Service Swagger
        - id: auth-swagger-ui
          uri: http://localhost:8081
          predicates:
            - Path=/swagger/auth/**
          filters:
            - RewritePath=/swagger/auth/(?<segment>.*), /$\{segment}

        # Auth Service API Docs
        - id: auth-api-docs
          uri: http://localhost:8081
          predicates:
            - Path=/api-docs/auth/**
          filters:
            - RewritePath=/api-docs/auth/(?<segment>.*), /$\{segment}

        # 일반 API 라우트
        - id: auth-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/auth/**
          filters:
            - RewritePath=/api/auth/(?<segment>.*), /${segment}

        - id: buyer-service
          uri: lb://buyer-service
          predicates:
            - Path=/api/buyers/**
          filters:
            - RewritePath=/api/buyers/(?<segment>.*), /${segment}
            - AuthenticationFilter # [8] JWT 검증 + 사용자 헤더 전달

        - id: cart-service
          uri: lb://cart-service
          predicates:
            - Path=/api/carts/**
          filters:
            - RewritePath=/api/carts/(?<segment>.*), /${segment}
            - AuthenticationFilter

        - id: product-service
          uri: lb://product-service
          predicates:
            - Path=/api/products/**
          filters:
            - RewritePath=/api/products/(?<segment>.*), /${segment}

        - id: seller-service
          uri: lb://seller-service
          predicates:
            - Path=/api/sellers/**
          filters:
            - RewritePath=/api/sellers/(?<segment>.*), /${segment}
            - AuthenticationFilter

        - id: farm-service
          uri: lb://farm-service
          predicates:
            - Path=/api/farms/**
          filters:
            - RewritePath=/api/farms/(?<segment>.*), /${segment}

        - id: order-service
          uri: lb://order-service
          predicates:
            - Path=/api/orders/**
          filters:
            - RewritePath=/api/orders/(?<segment>.*), /${segment}
            - AuthenticationFilter

        - id: payment-service
          uri: lb://payment-service
          predicates:
            - Path=/api/payments/**
          filters:
            - RewritePath=/api/payments/(?<segment>.*), /${segment}
            - AuthenticationFilter

        - id: settlement-service
          uri: lb://settlement-service
          predicates:
            - Path=/api/settlements/**
          filters:
            - RewritePath=/api/settlements/(?<segment>.*), /${segment}
            - AuthenticationFilter

        - id: delivery-service
          uri: lb://delivery-service
          predicates:
            - Path=/api/deliveries/**
          filters:
            - RewritePath=/api/deliveries/(?<segment>.*), /${segment}
            - AuthenticationFilter

        - id: notification-service
          uri: lb://notification-service
          predicates:
            - Path=/api/notifications/**
          filters:
            - RewritePath=/api/notifications/(?<segment>.*), /${segment}
            - AuthenticationFilter

        - id: experience-service
          uri: lb://experience-service
          predicates:
            - Path=/api/experiences/**
          filters:
            - RewritePath=/api/experiences/(?<segment>.*), /${segment}

        - id: search-service
          uri: lb://search-service
          predicates:
            - Path=/api/search/**
          filters:
            - RewritePath=/api/search/(?<segment>.*), /${segment}

        - id: review-service
          uri: lb://review-service
          predicates:
            - Path=/api/reviews/**
          filters:
            - RewritePath=/api/reviews/(?<segment>.*), /${segment}


springdoc:
  swagger-ui:
    urls:
      - name: Auth Service
        url: /api/auth/v3/api-docs
      - name: Buyer Service
        url: /api/buyers/v3/api-docs
      - name: Cart Service
        url: /api/carts/v3/api-docs
      - name: Product Service
        url: /api/products/v3/api-docs
      - name: Seller Service
        url: /api/sellers/v3/api-docs
      - name: Farm Service
        url: /api/farms/v3/api-docs
      - name: Order Service
        url: /api/orders/v3/api-docs
      - name: Payment Service
        url: /api/payments/v3/api-docs
    path: /swagger-ui.html


eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/ # [9] README 기준 Eureka 주소
    fetch-registry: true # [10] 라우팅 시 최신 인스턴스 목록 사용
    register-with-eureka: true # [11] 게이트웨이 자신도 등록해 모니터링 및 헬스 확인
  instance:
    prefer-ip-address: true # [12] DNS 미설정 환경에서 연결 실패 방지

jwt:
  secret: barofarm-secret-key-for-jwt-authentication-must-be-256-bits-long # [13] HMAC 키 — 실운영에서는 Config Server 등 외부화 필요

management:
  endpoints:
    web:
      exposure:
        include: health, info, gateway # [14] 게이트웨이 라우트/헬스 상태 조회 허용

# [footnotes]
# [3] spring-cloud-starter-config와 함께 사용되어 부트스트랩 단계에 설정을 주입한다(서비스 재배포 없이 설정 교체 가능).
# [8] 인증이 필요한 라우트만 AuthenticationFilter를 붙여 경로별 보안 정책을 구분할 수 있다.
# [13] Config Server의 암호화/외부 비밀관리로 이동하는 것이 안전하다.
