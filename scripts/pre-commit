#!/bin/sh
#
# Pre-commit hook for Baro Farm project
# 커밋 전 코드 품질 검사 실행
#

echo "🔍 Pre-commit hook 실행 중..."

# 프로젝트 루트 디렉토리로 이동
cd "$(git rev-parse --show-toplevel)" || exit 1

# Gradle 데몬 중지 (lock 파일 문제 방지)
./gradlew --stop > /dev/null 2>&1

# 코드 품질 검사 (Spotless + Checkstyle)
echo ""
echo "📝 코드 품질 검사 중..."

# lint 실행 (빌드 실패 시 예외 처리)
OUTPUT_FILE="/tmp/gradle_output_$$.txt"
./gradlew lint --no-daemon -q 2>&1 | tee "$OUTPUT_FILE"
LINT_EXIT=$?

# 빌드 실패인지 실제 검사 실패인지 확인
if [ $LINT_EXIT -ne 0 ]; then
    # 빌드 실패 (의존성 문제 등) 체크
    BUILD_FAILURE_PATTERNS="Could not resolve|FAILURE: Build failed|Could not find|Execution failed for task"
    
    if grep -qE "$BUILD_FAILURE_PATTERNS" "$OUTPUT_FILE" 2>/dev/null; then
        echo ""
        echo "⚠️  빌드 실패로 인해 코드 품질 검사를 건너뜁니다."
        echo "   (Spring Cloud Gateway 등 의존성 문제는 무시하고 커밋을 진행합니다)"
        echo ""
        rm -f "$OUTPUT_FILE"
        exit 0
    else
        # 실제 검사 실패
        echo ""
        echo "❌ 코드 품질 검사 실패!"
        echo "👉 포맷 자동 수정: ./gradlew format"
        echo "👉 상세 내용 확인: build/reports/checkstyle/"
        echo ""
        rm -f "$OUTPUT_FILE"
        exit 1
    fi
fi

rm -f "$OUTPUT_FILE"

rm -f /tmp/gradle_output.txt

echo "✅ 코드 품질 검사 통과"
echo ""
echo "🎉 모든 검사 통과! 커밋을 진행합니다."
exit 0
