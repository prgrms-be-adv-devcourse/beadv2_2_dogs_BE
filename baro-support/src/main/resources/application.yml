server:
  port: 8089

api:
  v1: /api/v1

spring:
  application:
    name: support-service
  main:
    allow-bean-definition-overriding: true
  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:mysql://baro-mysql:3306/${MYSQL_DATABASE:-barosupport}?useSSL=false&serverTimezone=Asia/Seoul&allowPublicKeyRetrieval=true&useUnicode=true}
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: ${MYSQL_USER:}
    password: ${MYSQL_PASSWORD:}
  jpa:
    hibernate:
      ddl-auto: update  # 일시적으로 update로 변경 (스키마 수정 후 validate로 변경)
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQLDialect
        use_sql_comments: true
  batch:
    job:
      enabled: false
  task:
    scheduling:
      cron:
        settlement: "0 0 0 1 * *"

  mail:
    host: smtp.naver.com
    port: 465
    username: ${SPRING_MAIL_USERNAME:}
    password: ${SPRING_MAIL_PASSWORD:}
    properties:
      mail.smtp.auth: true
      mail.smtp.ssl.enable: true
      mail.smtp.ssl.trust: smtp.naver.com
      
  elasticsearch:
    uris: ${SPRING_ELASTICSEARCH_URIS:http://elasticsearch:9200}
  kafka:
    bootstrap-servers: ${SPRING_KAFKA_BOOTSTRAP_SERVERS:localhost:29092}
    consumer:
      group-id: support-service
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
        spring.json.type.mapping: productEvent:com.barofarm.support.event.ProductEvent
        spring.json.use.type.headers: false
        spring.json.value.default.type: com.barofarm.support.event.ProductEvent
        # 재연결 설정
        reconnect.backoff.ms: 50          # 재연결 시 초기 백오프 시간 (50ms)
        reconnect.backoff.max.ms: 1000    # 재연결 시 최대 백오프 시간 (1초)
        # 세션 및 하트비트 설정
        session.timeout.ms: 30000          # 세션 타임아웃 (30초)
        heartbeat.interval.ms: 3000        # 하트비트 간격 (3초)
        # 폴링 및 요청 타임아웃 설정
        max.poll.interval.ms: 300000       # 최대 폴링 간격 (5분)
        request.timeout.ms: 30000          # 요청 타임아웃 (30초)
        # 메타데이터 갱신 설정
        metadata.max.age.ms: 300000        # 메타데이터 최대 유지 시간 (5분)
        # 연결 재시도 설정
        connections.max.idle.ms: 540000    # 최대 유휴 연결 시간 (9분)
      auto-offset-reset: latest  # earliest에서 latest로 변경하여 오래된 메시지 건너뛰기
      # auto-offset-reset: earliest
    listener:
      # Consumer 재시작 설정
      auto-startup: true                   # 자동 시작
      # 에러 처리 설정
      ack-mode: batch                      # 배치 단위로 커밋
      # 재시도 설정
      concurrency: 1                       # 동시 Consumer 스레드 수

eureka:
  client:
    service-url:
      # Docker 환경에서는 서비스 이름(eureka) 사용, 로컬에서는 localhost 사용
      # 환경 변수 EUREKA_CLIENT_SERVICEURL_DEFAULTZONE으로 오버라이드 가능
      defaultZone: ${EUREKA_CLIENT_SERVICEURL_DEFAULTZONE:http://eureka:8761/eureka/}
  instance:
    prefer-ip-address: true

# Eureka 명시적 비활성화 (local 프로파일)
# eureka:
#   client:
#     enabled: false
#     register-with-eureka: false
#     fetch-registry: false
#   instance:
#     enabled: false

# 로깅 설정
logging:
  level:
    root: INFO
    com.barofarm.support: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.hibernate.orm.jdbc.bind: TRACE
    org.springframework.web: DEBUG
    org.springframework.web.servlet.DispatcherServlet: DEBUG

# Actuator 설정
management:
  endpoints:
    web:
      exposure:
        include: refresh, health, beans, info
  endpoint:
    health:
      enabled: true
      show-details: always

# Swagger/OpenAPI 설정
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    tags-sorter: alpha
    operations-sorter: alpha
  default-consumes-media-type: application/json
  default-produces-media-type: application/json

# AWS 및 S3 설정
cloud:
  aws:
    s3:
      bucket: ${AWS_S3_BUCKET_NAME}
      public-base-url: https://${AWS_S3_BUCKET_NAME}.s3.ap-northeast-2.amazonaws.com
    credentials:
      access-key: ${AWS_ACCESS_KEY}
      secret-key: ${AWS_SECRET_KEY}
    region: ap-northeast-2
